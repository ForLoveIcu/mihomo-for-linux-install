name: è‡ªåŠ¨æ›´æ–°äºŒè¿›åˆ¶æ–‡ä»¶

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  update-binaries:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ£€æŸ¥æ–°ç‰ˆæœ¬
      id: check
      run: |
        # è·å–æœ€æ–°ç‰ˆæœ¬
        LATEST=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | jq -r .tag_name)
        echo "latest=$LATEST" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        if [ -f VERSION ]; then
          CURRENT=$(cat VERSION)
          if [ "$LATEST" = "$CURRENT" ]; then
            echo "need_update=false" >> $GITHUB_OUTPUT
          else
            echo "need_update=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "need_update=true" >> $GITHUB_OUTPUT
        fi
        
    - name: ä¸‹è½½æ–°ç‰ˆæœ¬
      if: steps.check.outputs.need_update == 'true'
      run: |
        VERSION=${{ steps.check.outputs.latest }}
        mkdir -p binaries
        
        # ä¸‹è½½å„æ¶æ„ç‰ˆæœ¬
        wget -O binaries/mihomo-linux-amd64-v1-${VERSION}.gz \
          https://github.com/MetaCubeX/mihomo/releases/download/${VERSION}/mihomo-linux-amd64-v1-${VERSION}.gz
        
        wget -O binaries/mihomo-linux-arm64-${VERSION}.gz \
          https://github.com/MetaCubeX/mihomo/releases/download/${VERSION}/mihomo-linux-arm64-${VERSION}.gz
        
        wget -O binaries/mihomo-linux-armv7-${VERSION}.gz \
          https://github.com/MetaCubeX/mihomo/releases/download/${VERSION}/mihomo-linux-armv7-${VERSION}.gz
        
        # ä¸‹è½½ WebUI
        wget -O binaries/metacubexd.tgz \
          https://github.com/MetaCubeX/metacubexd/releases/latest/download/compressed-dist.tgz
        
        # æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
        echo $VERSION > VERSION
        
    - name: æäº¤æ›´æ–°
      if: steps.check.outputs.need_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°åˆ°ç‰ˆæœ¬ ${{ steps.check.outputs.latest }}"
        git push
